{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Epstein Studio Register</title>
    <link rel="stylesheet" href="{% static 'epstein_ui/style.css' %}" />
  </head>
  <body>
    <div class="page">
      <header class="topbar">
        <div class="brand">Epstein Studio</div>
      </header>
      <main class="layout" style="grid-template-columns: 1fr;">
        <section class="panel" style="max-width: 460px; margin: 8vh auto 0;">
          <div class="tab-panel active" style="display: flex;">
            <div class="hint">Create a username and password.</div>
            <form method="post" style="display: flex; flex-direction: column; gap: 16px;">
              {% csrf_token %}
              <label class="field">
                <span>Username</span>
                <input id="usernameField" type="text" name="username" autocomplete="username" required autofocus value="{{ form.data.username|default_if_none:'' }}" />
                <div id="usernameHint" class="hint" style="display: none;"></div>
                {% if form.errors.username %}
                  <div class="hint" style="color: #ff6b6b;">{{ form.errors.username|join:", " }}</div>
                {% endif %}
              </label>
              <label class="field">
                <span>Password</span>
                <input type="password" name="password1" autocomplete="new-password" required />
              </label>
              <label class="field">
                <span>Confirm Password</span>
                <input type="password" name="password2" autocomplete="new-password" required />
              </label>
              <button type="submit" class="btn">Create Account</button>
            </form>
            <div class="hint">Already have an account? <a href="/login/">Log in</a></div>
          </div>
        </section>
      </main>
    </div>
    <script>
      const usernameField = document.getElementById("usernameField");
      const usernameHint = document.getElementById("usernameHint");
      let usernameTimer = null;

      function setUsernameHint(message, ok = false) {
        if (!usernameHint) return;
        if (!message) {
          usernameHint.style.display = "none";
          usernameHint.textContent = "";
          return;
        }
        usernameHint.style.display = "block";
        usernameHint.textContent = message;
        usernameHint.style.color = ok ? "#9fe88c" : "#ff6b6b";
      }

      if (usernameField) {
        usernameField.addEventListener("input", () => {
          if (usernameTimer) window.clearTimeout(usernameTimer);
          const value = usernameField.value.trim();
          if (!value) {
            setUsernameHint("");
            return;
          }
          usernameTimer = window.setTimeout(async () => {
            try {
              const res = await fetch(`/username-check/?u=${encodeURIComponent(value)}`);
              if (!res.ok) return;
              const data = await res.json();
              if (data.available) {
                setUsernameHint("Username is available.", true);
              } else {
                setUsernameHint("Username is already taken.");
              }
            } catch (err) {
              console.error(err);
            }
          }, 250);
        });
      }
    </script>
  </body>
</html>
