{% load static %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Sign In - Epstein Studio</title>
    <link rel="icon" href="{% static 'epstein_ui/favicon.ico' %}" type="image/x-icon" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'epstein_ui/style-modern.css' %}" />
  </head>
  <body>
    <div class="page login-layout">
      <header class="topbar">
        <div class="topbar-row">
          <div class="topbar-left">
            <a href="/" class="brand">Epstein Studio</a>
          </div>
          <div class="topbar-actions">
            <a class="btn btn-secondary" href="/about/">About</a>
            <a class="btn btn-secondary" href="/browse/">Browse</a>
            <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
              <svg class="sun-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
              </svg>
              <svg class="moon-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
              </svg>
            </button>
          </div>
        </div>
      </header>
      
      <main class="auth-layout">
        <div class="auth-sidebar">
          <div class="auth-sidebar-content">
            <h2 class="auth-sidebar-title">Join the Investigation</h2>
            <p class="auth-sidebar-text">Help uncover the truth by annotating and discussing thousands of court documents.</p>
            <div class="auth-sidebar-stats">
              <div class="auth-sidebar-stat">
                <span class="auth-sidebar-stat-value">2,000+</span>
                <span class="auth-sidebar-stat-label">Documents</span>
              </div>
              <div class="auth-sidebar-stat">
                <span class="auth-sidebar-stat-value">Open</span>
                <span class="auth-sidebar-stat-label">Source</span>
              </div>
            </div>
          </div>
        </div>
        <div class="auth-main">
          <div class="login-card">
            <div class="login-header">
              <h1>Welcome Back</h1>
              <p>Sign in to continue annotating documents.</p>
            </div>
            
            {% if form.errors %}
              <div class="login-error">
                {% if form.non_field_errors %}
                  {{ form.non_field_errors|join:", " }}
                {% else %}
                  Invalid username or password.
                {% endif %}
              </div>
            {% endif %}
            
            <form method="post" class="login-form" action="{% url 'login' %}">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ next|default:'/' }}" />
              <label class="field">
                <span>Username</span>
                <input type="text" name="username" autocomplete="username" required autofocus value="{{ form.username.value|default:'' }}" />
              </label>
              <label class="field">
                <span>Password</span>
                <input type="password" name="password" autocomplete="current-password" required />
              </label>
              <button type="submit" class="btn btn-lg" style="width: 100%;">Sign In</button>
            </form>
            
            <div class="auth-divider">
              <span>or</span>
            </div>
            
            <div class="wallet-auth">
              <button id="connectWalletBtn" class="btn btn-wallet" type="button">
                <svg width="20" height="20" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;">
                  <circle cx="64" cy="64" r="64" fill="url(#solana-gradient)"/>
                  <defs>
                    <linearGradient id="solana-gradient" x1="0" y1="0" x2="128" y2="128">
                      <stop offset="0%" stop-color="#9945FF"/>
                      <stop offset="100%" stop-color="#14F195"/>
                    </linearGradient>
                  </defs>
                  <path d="M93.5 74.8L85.1 83.7C84.8 84 84.4 84.2 84 84.2H36.5C35.8 84.2 35.4 83.4 35.9 82.9L44.3 74C44.6 73.7 45 73.5 45.4 73.5H92.9C93.6 73.5 94 74.3 93.5 74.8ZM85.1 55.3L93.5 64.2C94 64.7 93.6 65.5 92.9 65.5H45.4C45 65.5 44.6 65.3 44.3 65L35.9 56.1C35.4 55.6 35.8 54.8 36.5 54.8H84C84.4 54.8 84.8 55 85.1 55.3ZM93.5 35.8L85.1 44.7C84.8 45 84.4 45.2 84 45.2H36.5C35.8 45.2 35.4 44.4 35.9 43.9L44.3 35C44.6 34.7 45 34.5 45.4 34.5H92.9C93.6 34.5 94 35.3 93.5 35.8Z" fill="white"/>
                </svg>
                Connect Wallet
              </button>
              <p id="walletStatus" class="wallet-status"></p>
            </div>
            
            <div class="login-footer">
              <p>First time here? <a href="/register/">Create an anonymous account</a></p>
            </div>
            
            <div class="login-privacy">
              <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
              <span>This site does not collect personal information. Your ID is only used for managing annotations and discussions.</span>
            </div>
          </div>
        </div>
      </main>
    </div>
    <script>
      // Theme Toggle
      (function() {
        const themeKey = 'epstein_theme';
        const toggle = document.getElementById('themeToggle');
        const savedTheme = localStorage.getItem(themeKey);
        
        if (savedTheme) {
          document.documentElement.setAttribute('data-theme', savedTheme);
        } else if (window.matchMedia('(prefers-color-scheme: light)').matches) {
          document.documentElement.setAttribute('data-theme', 'light');
        }
        
        if (toggle) {
          toggle.addEventListener('click', function() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem(themeKey, next);
          });
        }
      })();
      
      (function() {
        const btn = document.getElementById('connectWalletBtn');
        const status = document.getElementById('walletStatus');
        
        btn.addEventListener('click', async () => {
          status.textContent = '';
          status.className = 'wallet-status';
          
          // Check for Phantom wallet
          if (!window.solana || !window.solana.isPhantom) {
            status.textContent = 'Please install Phantom wallet';
            status.classList.add('wallet-status-err');
            window.open('https://phantom.app/', '_blank');
            return;
          }
          
          try {
            btn.disabled = true;
            btn.textContent = 'Connecting...';
            
            // Connect to wallet
            const resp = await window.solana.connect();
            const walletAddress = resp.publicKey.toString();
            
            // Get nonce from server
            const nonceResp = await fetch('/solana/nonce/', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({wallet: walletAddress}),
            });
            const nonceData = await nonceResp.json();
            if (!nonceResp.ok) {
              throw new Error(nonceData.error || 'Failed to get nonce');
            }
            
            // Sign the message
            const message = new TextEncoder().encode(nonceData.message);
            const signedMessage = await window.solana.signMessage(message, 'utf8');
            const signature = btoa(String.fromCharCode(...signedMessage.signature));
            
            // Verify with server
            const verifyResp = await fetch('/solana/verify/', {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify({
                wallet: walletAddress,
                signature: signature,
                nonce: nonceData.nonce,
              }),
            });
            const verifyData = await verifyResp.json();
            if (!verifyResp.ok) {
              throw new Error(verifyData.error || 'Verification failed');
            }
            
            status.textContent = verifyData.action === 'login' 
              ? 'Signed in as ' + verifyData.username
              : 'Account created: ' + verifyData.username;
            status.classList.add('wallet-status-ok');
            
            // Redirect after success
            setTimeout(() => {
              window.location.href = '{{ next|default:"/" }}';
            }, 1000);
            
          } catch (err) {
            console.error('Wallet auth error:', err);
            status.textContent = err.message || 'Connection failed';
            status.classList.add('wallet-status-err');
          } finally {
            btn.disabled = false;
            btn.innerHTML = `<svg width="20" height="20" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;"><circle cx="64" cy="64" r="64" fill="url(#solana-gradient)"/><defs><linearGradient id="solana-gradient" x1="0" y1="0" x2="128" y2="128"><stop offset="0%" stop-color="#9945FF"/><stop offset="100%" stop-color="#14F195"/></linearGradient></defs><path d="M93.5 74.8L85.1 83.7C84.8 84 84.4 84.2 84 84.2H36.5C35.8 84.2 35.4 83.4 35.9 82.9L44.3 74C44.6 73.7 45 73.5 45.4 73.5H92.9C93.6 73.5 94 74.3 93.5 74.8ZM85.1 55.3L93.5 64.2C94 64.7 93.6 65.5 92.9 65.5H45.4C45 65.5 44.6 65.3 44.3 65L35.9 56.1C35.4 55.6 35.8 54.8 36.5 54.8H84C84.4 54.8 84.8 55 85.1 55.3ZM93.5 35.8L85.1 44.7C84.8 45 84.4 45.2 84 45.2H36.5C35.8 45.2 35.4 44.4 35.9 43.9L44.3 35C44.6 34.7 45 34.5 45.4 34.5H92.9C93.6 34.5 94 35.3 93.5 35.8Z" fill="white"/></svg>Connect Wallet`;
          }
        });
      })();
    </script>
  </body>
</html>
